<div class="page-background"></div>
<app-header></app-header>

<div class="create-container">
  <div class="form-card">
    <div class="header-section">
      <h1>РЕДАГУВАТИ РЕЦЕПТ</h1>
      <hr class="form-line" />
    </div>

    <form [formGroup]="recipeForm" (ngSubmit)="submitRecipe()">
      
      <div class="form-group">
        <label>НАЗВА СТРАВИ <span class="required">*</span></label>
        <input type="text" class="form-control" formControlName="title" placeholder="Наприклад: Борщ український">
      </div>

      <div class="form-group">
        <label>ОПИС <span class="required">*</span></label>
        <textarea class="form-control" formControlName="description" rows="3" placeholder="Розкажіть про особливості цієї страви..."></textarea>
      </div>

      <div class="form-group photo-upload-section">
        <label>ФОТО СТРАВИ</label>
        <div class="upload-area">
          <div class="photo-preview" *ngIf="photoUrl">
              <img [src]="photoUrl" alt="Recipe preview">
          </div>
          <input type="file" (change)="onFileSelected($event)" accept="image/*" id="fileInput" class="file-input">
          <label for="fileInput" class="file-label" *ngIf="!photoUrl">
             <i class="fas fa-cloud-upload-alt"></i> Виберіть фото
          </label>
          <label for="fileInput" class="file-label-change" *ngIf="photoUrl">Змінити фото</label>
          <p *ngIf="isUploading" class="uploading-text">Завантаження...</p>
        </div>
      </div>

      <div class="params-row">
        <div class="form-group small-input">
            <label>ЧАС (хв)</label>
            <input type="number" class="form-control" formControlName="cookingTime">
        </div>
        <div class="form-group small-input">
            <label>КАЛОРІЇ</label>
            <input type="number" class="form-control" formControlName="calories">
        </div>
        <div class="form-group small-input">
            <label>ПОРЦІЇ</label>
            <input type="number" class="form-control" formControlName="servings">
        </div>
      </div>

      <hr class="section-divider">
      
      <div class="section-header">
        <h2>ІНГРЕДІЄНТИ</h2>
      </div>

      <div formArrayName="ingredients" class="ingredients-list">
        <div *ngFor="let ing of ingredients.controls; let i=index" [formGroupName]="i" class="ingredient-row">
            
            <div class="input-wrapper name-wrapper">
                <input type="text" class="form-control" formControlName="name" placeholder="Назва інгредієнта" 
                       (input)="searchIngredient($event, i)" (blur)="hideSearch()" autocomplete="off">
                
                <ul class="search-dropdown" *ngIf="isSearchFocused && currentIngredientIndex === i && searchResults.length > 0">
                    <li *ngFor="let result of searchResults" (mousedown)="selectIngredient(result)">
                        {{ result.name }}
                    </li>
                </ul>
            </div>

            <input type="number" class="form-control qty-input" formControlName="quantity" placeholder="К-сть">
            
            <div class="custom-select-wrapper">
              <div class="form-control unit-trigger" 
                   [class.active]="openDropdownIndex === i"
                   (click)="toggleUnitDropdown(i, $event)">
                  <span>{{ ingredients.at(i).get('unit')?.value || 'Од.' }}</span>
                  <i class="fas fa-chevron-down arrow-icon"></i>
              </div>
              <ul class="custom-options-list" *ngIf="openDropdownIndex === i">
                  <li *ngFor="let unit of weightUnits" 
                      (click)="selectUnit(unit.type, i)"
                      [class.selected]="unit.type === ingredients.at(i).get('unit')?.value">
                      {{ unit.type }}
                  </li>
              </ul>
            </div>

            <button type="button" class="remove-btn" (click)="removeIngredient(i)" title="Видалити">
              <i class="fas fa-trash"></i>
            </button>
        </div>
      </div>
      
      <button type="button" class="add-btn-text" (click)="addIngredient()">
        <i class="fas fa-plus-circle"></i> Додати інгредієнт
      </button>

      <hr class="section-divider">

      <div class="section-header">
        <h2>КРОКИ ПРИГОТУВАННЯ</h2>
      </div>

      <div formArrayName="cookingSteps" class="steps-list">
        <div *ngFor="let step of cookingSteps.controls; let i=index" [formGroupName]="i" class="step-row">
            <div class="step-number">{{i + 1}}</div>
            <textarea class="form-control step-desc" formControlName="description" rows="2" placeholder="Опишіть процес приготування..."></textarea>
            <button type="button" class="remove-btn" (click)="removeStep(i)" title="Видалити">
              <i class="fas fa-trash"></i>
            </button>
        </div>
      </div>

      <button type="button" class="add-btn-text" (click)="addStep()">
        <i class="fas fa-plus-circle"></i> Додати крок
      </button>

      <br><br>
      <button type="submit" class="submit-btn" [disabled]="recipeForm.invalid || isUploading">
        ЗБЕРЕГТИ ЗМІНИ
      </button>

    </form>
  </div>
</div>